;;; config/80_site-package.el --- installed package configurations

;; Copyright (C) 2012-2020 Zachary Elliott
;; See COPYING for more information

;; This file is not part of GNU Emacs.

;;; Commentary:

;;; Code:


;;; No Littering
(use-package no-littering
  :init (setq
         no-littering-var-directory (expand-file-name "data/" user-emacs-directory))

  :config (progn
            (setq custom-file (no-littering-expand-etc-file-name "custom.el"))

            (push 'no-littering-var-directory recentf-exclude)
            (push 'no-littering-etc-directory recentf-exclude)))


;;; Load PATH variable from zsh for Darwin because ... reason
(use-package exec-path-from-shell
  :if (eq system-type 'darwin)
  :config (progn
            (setq
             exec-path-from-shell-variables '("PATH" "MANPATH" "WORKON_HOME"))
            (exec-path-from-shell-initialize)))


;;; Doom Modeline
(use-package doom-modeline
  :init (doom-modeline-mode t))


;;; Rainbow Delimiters Mode
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))


;;; Compilation
(use-package compile
  :config (setq compilation-scroll-output t))


;;; ANSI Colours
(use-package ansi-color
  :config (add-to-list 'comint-output-filter-functions 'ansi-color-process-output)
  :hook ((compilation-filter . (lambda ()
                                 (let ((buffer-read-only nil))
                                   (ansi-color-apply-on-region compilation-filter-start (point)))))
         (shell-mode . ansi-color-for-comint-mode-on)))


;;; Projectile
(use-package projectile
  :init (projectile-mode +1)
  :bind (:map projectile-mode-map
              ("s-p" . projectile-command-map)
              ("C-c p" . projectile-command-map)))


;;; All the Icons
(use-package all-the-icons)


;;; Dired All the Icons
(use-package all-the-icons-dired
  :after (all-the-icons)
  :hook (dired-mode . all-the-icons-dired-mode))


;;; Dired Sidebar
(use-package dired-sidebar
  :bind (("C-x C-n" . dired-sidebar-toggle-sidebar))
  :commands (dired-sidebar-toggle-sidebar)
  :hook (dired-sidebar-mode . (lambda ()
                                (unless (file-remote-p default-directory)
                                  (auto-revert-mode))))
  :config (progn
            (push 'toggle-window-split dired-sidebar-toggle-hidden-commands)
            (push 'rotate-windows dired-sidebar-toggle-hidden-commands)

            (setq
             dired-sidebar-use-term-integration t
             dired-sidebar-use-custom-font t)))


;;; Magit Mode
(use-package magit
  :bind (("C-c m s" . magit-status)
         ("C-c m b" . magit-blame)
         ("C-c m p" . magit-process-mode)))


;;; Yasnippet
(use-package yasnippet)


;;; Flyspell Mode
(use-package flyspell
  :config (setq
           ispell-program-name "aspell"
           ispell-extra-args '("--sug-mode=fast"))

  :hook ((text-mode . (lambda () (flyspell-mode 1)))
         (prog-mode . flyspell-prog-mode)))


;;; Flycheck
(use-package flycheck
  :config (progn
            (setq flycheck-temp-prefix ".flycheck")
            (global-flycheck-mode)))


;;; Markdown Mode
(use-package markdown-mode
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))

  :config (setq
           markdown-indent-on-enter nil))


;;; YAML Mode
(use-package yaml-mode
  :config (setq
           yaml-block-literal-search-lines 512))


;;; Jinja2 templates
(use-package jinja2-mode)


;; Bison/Flex Mode
(use-package bison-mode)


;;; Dockerfile Mode
(use-package dockerfile-mode
  :init (progn
          (put 'docker-image-name 'safe-local-variable #'stringp)
          (put 'dockerfile-image-name 'safe-local-variable #'stringp))

  :config (setq
           dockerfile-build-args '("--pull" "--rm")))


;;; Docker Mode
(use-package docker
  :bind ("C-c d" . docker))


;;; Lua Mode
(use-package lua-mode)


;;; Terraform Mode
(use-package terraform-mode
  :config (setq terraform-indent-level 2)
  :hook (terraform-mode . terraform-format-on-save-mode))


;; Ruby
;;; enhanced ruby mode
(use-package enh-ruby-mode
  :mode (("\\.rb\\'" . enh-ruby-mode)
         ("\\.ru\\'" . enh-ruby-mode)
         ("\\.rake\\'" . enh-ruby-mode)
         ("\\.gemspec\\'" . enh-ruby-mode)
         ("\\.jbuilder\\'" . enh-ruby-mode)
         ("\\.podspec\\'" . enh-ruby-mode)
         ("\\.thor\\'" . enh-ruby-mode)
         ("Gemfile\\'" . enh-ruby-mode)
         ("Rakefile\\'" . enh-ruby-mode)
         ("Podfile\\'" . enh-ruby-mode)
         ("Thorfile\\'" . enh-ruby-mode)
         ("Guardfile\\'" . enh-ruby-mode)
         ("Vagrantfile\\'" . enh-ruby-mode)
         ("Capfile\\'" . enh-ruby-mode))

  :config (progn
            (setq ruby-insert-encoding-magic-comment nil
                  enh-ruby-indent-level 2
                  enh-ruby-add-encoding-comment-on-save nil
                  enh-ruby-deep-indent-paren nil
                  enh-ruby-bounce-deep-indent t
                  enh-ruby-hanging-indent-level 2)))

(use-package inf-ruby
  :config (setq
           inf-ruby-console-environment "pry"))

(use-package rubocop)

(use-package rvm
  :config (setq
           rvm--gemset-default "emacs")

  :hook ((ruby-mode enh-ruby-mode) . rvm-activate-corresponding-ruby))

(use-package robe
  :config (with-eval-after-load "company"
            (push 'company-robe company-backends)))

(use-package bundler)


;;; Rust
(use-package rust-mode
  :config (setq
           rust-format-on-save t))

(use-package flycheck-rust
  :after (flycheck rust-mode)
  :hook (flycheck-mode . flycheck-rust-setup))

(use-package racer
  :after (rust-mode)
  :hook (rust-mode . racer-mode))

(use-package cargo
  :after (rust-mode)
  :hook (rust-mode . cargo-minor-mode))


;; Groovy
(use-package groovy-mode
  :mode (("Jenkinsfile\\'" . groovy-mode))
  :config (setq
           lsp-groovy-server-file "/Users/zellio/repos/prominic/groovy-language-server/build/libs/groovy-language-server-all.jar"))


;;; Python
(use-package python-mode)

(use-package pipenv
  :after (python-mode)

  :hook ((python-mode . (lambda ()
                          (unless (and (boundp 'user/pipenv-dir-cache)
                                       (string= (pipenv-project?) user/pipenv-dir-cache))
                            (setq user/pipenv-dir-cache (pipenv-project?))
                            (pipenv-deactivate)
                            (pipenv-activate))))
         (python-mode . (lambda ()
                          (when (pipenv-project-p)
                            (setq-local lsp-pyls-server-command '("pipenv" "run" "pylsp")))))
         (python-mode . pipenv-mode))

  :config (setq
           pipenv-executable "/Users/zellio/.pyenv/shims/pipenv"
           pipenv-projectile-after-switch-function nil)

  :commands (pipenv-mode
             pipenv-activate
             pipenv-run))

(use-package poetry
  :after (python-mode)
  :commands (poetry-find-project-root)
  :hook ((python-mode . poetry-tracking-mode)
         (python-mode . (lambda ()
                          (when (poetry-find-project-root)
                            (setq-local lsp-pyls-server-command
                                        '("poetry" "run" "pylsp")))))))


;;; LSP
(use-package lsp-mode
  :config (progn
            (setq
             lsp-message-project-root-warning t
             lsp-auto-configure t
             lsp-enable-snippet t
             lsp-keymap-prefix "C-c l"

             lsp-client-packages (delete 'lsp-steep lsp-client-packages)
             lsp-clinet-packages (delete 'pyls lsp-client-packages))
            ;;; Add better terraform lsp server
            (lsp-register-client
             (make-lsp-client :new-connection (lsp-stdio-connection '("terraform-ls" "serve"))
                              :major-modes '(terraform-mode)
                              :priority 1
                              :server-id 'terraform-ls))
            (define-key lsp-mode-map (kbd "C-c l") lsp-command-map))

  :hook (((c-mode-common lua-mode python-mode enh-ruby-mode rust-mode groovy-mode terraform-mode) . lsp-deferred)
         (lsp-mode . yas-minor-mode)))

(use-package lsp-ui
  :after (lsp)

  :config (setq
           lsp-ui-doc-enable t
           lsp-ui-flycheck-enable t
           lsp-ui-imenu-enable nil
           lsp-ui-peek-enable t

           ;; lsp-ui-flycheck-enable t
           ;; lsp-ui-sideline-enable t
           )

  :hook (lsp-mode . lsp-ui-mode)

  :bind (:map lsp-ui-mode-map
         ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
         ([remap xref-find-references] . lsp-ui-peek-find-references)))


;;; Helm LSP
(use-package helm-lsp
  :after (lsp)
  :commands helm-lsp-workspace-symbol
  :bind (:map lsp-mode-map
              ([remap xref-find-apropos] . helm-lsp-workspace-symbol)))


;;; Company
(use-package company
  :config (progn
            (setq
             company-frontends '(company-pseudo-tooltip-unless-just-one-frontend
                                 company-preview-frontend
                                 company-echo-metadata-frontend)
             company-tooltip-limit 10
             company-idle-delay 0.25
             company-minimum-prefix-length 2
             company-require-match 'never
             company-show-numbers t
             company-enable-lsp-snippet t)

            (add-to-list 'company-backends #'company-capf))

  :bind (:map company-active-map
         ("SPC" . (lambda () (interactive) (company-complete-selection) (insert " ")))
         ("TAB" . company-complete-common-or-cycle)
         ("<tab>" . company-complete-common-or-cycle)
         ("S-TAB" . company-select-previous)
         ("<backtab>" . company-select-previous))

  :hook (after-init . global-company-mode))

(use-package company-terraform
  :after (company)
  :config (progn
            (require 'company-terraform)
            (company-terraform-init)))

(use-package company-racer)

(use-package company-lsp
  :after (company lsp)
  :config (push '(company-lsp :with company-yasnippet) company-backends))


;;; config/80_site-package.el ends here
